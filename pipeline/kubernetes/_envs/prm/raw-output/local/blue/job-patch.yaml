apiVersion: flink.apache.org/v1beta1
kind: FlinkDeployment
metadata:
  name: flink-job
spec:
  job:
    args: [
      "--s3Bucket=promoted-event-logs",
      "--jobLabel=blue",
      "--sideOutputDebugLogging",
      "--startFromEarliest",

      "--parallelism=1",
      "--maxParallelism=2",

      "--excludeTables=diagnostics",
      "--excludeTables=invalid_diagnostics",
      "--excludeTables=invalid_cohort_membership",
      "--excludeTables=invalid_view",
      "--excludeTables=invalid_delivery_log",
      "--excludeTables=invalid_impression",
      "--excludeTables=invalid_action",

      # Periodically update the watermark locally.
      # Needs a longer delay for slow job startup.
      "--watermarkIdleness=PT5M",
      "--checkpointInterval=PT1M",

      "--writePaimonTables",
      "--paimonBasePath=s3a://promoted-event-logs/",
      "--no-disableAutoGeneratedUIDs",
      "--databaseName=raw",
      "--sideDatabaseName=raw_side",

      "--writePaimonTables",
      "--paimonBasePath=s3a://promoted-event-logs/paimon-test",
      "--paimonGlobalOptions=file.format=orc",
      "--paimonGlobalOptions=bucket=2",
      "--paimonGlobalOptions=sink.parallelism=2",
      "--paimonGlobalOptions=tag.automatic-creation=watermark",
      "--paimonGlobalOptions=tag.creation-period=daily",
      "--paimonGlobalOptions=tag.num-retained-max=10",
      "--paimonTableOptions=raw_blue.action.log.system=kafka",
      "--paimonTableOptions=raw_blue.action.log.consistency=eventual",
      "--paimonTableOptions=raw_blue.action.kafka.bootstrap.servers=kafka:9092",
      "--paimonTableOptions=raw_blue.action.kafka.topic=metrics.blue.default.action_paimon",
      "--paimonTableOptions=raw_blue.action.kafka.kafkaSecurityProtocol=SSL",
    ]
  flinkConfiguration:
    state.savepoints.dir: s3a://promoted-event-logs/raw-output-flink-job-blue/savepoints
    state.checkpoints.dir: s3a://promoted-event-logs/raw-output-flink-job-blue/checkpoints
    high-availability.storageDir: s3a://promoted-event-logs/raw-output-flink-job-blue/ha
